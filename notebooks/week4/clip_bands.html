
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>22. Clipping multiple bands– v0.2 &#8212; ATSC 301</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/week4/clip_bands';</script>
    <link rel="canonical" href="https://phaustin.github.io/a301_eoas/notebooks/week4/clip_bands.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="23. Optical depth II: mean free path" href="optical_depth2.html" />
    <link rel="prev" title="21. Optical depth and partial transmission" href="../week3/optical_depth.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
  
    <p class="title logo__title">ATSC 301</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../index.html">
                    ATSC 301: 2024 Term 2 Winter
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Useful links</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../syllabus.html">ATSC 301: syllabus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../integrity.html">UBC academic integrity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../texts.html">Texts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../assignments.html">A301 Assignments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pixi_install.html">pixi install for macos and windows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../windows_install.html">Windows installation using a conda lock file</a></li>
<li class="toctree-l1"><a class="reference external" href="https://drive.google.com/drive/folders/1-Ja2wVKVIjkZb7Gx_rfc14J_aBYiknuw?usp=sharing)">Notebook downloads</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notebook_index.html">code snippets by notebook</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Weekly topics</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../week_notes.html">Week notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../week_review.html">Weekly review</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Midterm</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../midterm/midterm_focus.html">1. Study topics for midterm</a></li>
<li class="toctree-l1"><a class="reference external" href="https://drive.google.com/file/d/1E6Gs6zUARHdEAb2UqIyMnyXj-jCiOiXw/view?usp=drive_link">2025 mid-term equation sheet</a></li>
<li class="toctree-l1"><a class="reference external" href="https://drive.google.com/file/d/12ZDN8NZzgafeCMDTy4t0u-w80o3-foNT/view?usp=sharing">2022 mid-term</a></li>
<li class="toctree-l1"><a class="reference internal" href="../midterm/mid_term_reviewI.html">2. Sample mid-term questions I</a></li>
<li class="toctree-l1"><a class="reference internal" href="../midterm/mid_term_reviewII.html">3. Midterm review questions II</a></li>
<li class="toctree-l1"><a class="reference internal" href="../midterm/mid_term_reviewI_solutions.html">4. Midterm Solutions: midterm sample questions I</a></li>
<li class="toctree-l1"><a class="reference internal" href="../midterm/mid_term_reviewII_solutions.html">5. Midterm solutions: sample questions II</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../solutions/midterm/a301_2024t2_midterm_solution.html">6. A301 midterm solutions</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Week 1</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference external" href="https://www.eoas.ubc.ca/books/Practical_Meteorology/prmet102/Ch02-radiation-v102b.pdf">Stull Chapter 2, pp. 34-43</a></li>
<li class="toctree-l1"><a class="reference internal" href="../week1/beers_law.html">7. Beers and inverse squared laws</a></li>
<li class="toctree-l1"><a class="reference external" href="https://gw2jh3xr2c.search.serialssolutions.com/?sid=sersol&amp;SS_jc=TC0000517195&amp;title=Atmospheric%20Science%3A%20An%20Introductory%20Survey">Wallace and Hobbs Chapter 4, pp. 113-118</a></li>
<li class="toctree-l1"><a class="reference internal" href="../week1/radiance.html">8. Solid angle and radiance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../week1/newflux.html">9. Finding the flux given the radiance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../week1/planck_function.html">10. Plotting the Planck function with python</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Week 2</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../week2/planck_sol.html">11. Plotting the Planck function - solution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../week2/assign1.html">12. Assignment 1, brightness temperatures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../week2/cartopy_maps.html">13. Introduction to Cartopy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../week2/cartopy_mapping_vancouver.html">14. Mapping Vancouver with cartopy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../week2/get_landsat_bands.html">15. Landsat 1: Dowloading Landsat and Sentinel data from NASA</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Week 3</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../week3/map_landsat.html">16. Mapping the landsat scene</a></li>
<li class="toctree-l1"><a class="reference internal" href="../week3/assign1_solution.html">17. Assignment 1, brightness temperatures - solution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../week3/zoom_landsat.html">18. Zooming an image</a></li>

<li class="toctree-l1"><a class="reference internal" href="../week3/kirchoff.html">20. Kirchoff worksheet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../week3/optical_depth.html">21. Optical depth and partial transmission</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Week 4</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">22. Clipping multiple bands– v0.2</a></li>
<li class="toctree-l1"><a class="reference internal" href="optical_depth2.html">23. Optical depth II: mean free path</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../solutions/assign2_solutionsA.html">24. Assignment 2: solutions Part A</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Week 5</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../solutions/assign4.html">25. Assignment 4</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../solutions/assign2_solutionsB.html">26. Assignment 2: solutions part B</a></li>
<li class="toctree-l1"><a class="reference internal" href="../week5/rowcol2latlon.html">27. Getting lat,lon from row, column</a></li>
<li class="toctree-l1"><a class="reference internal" href="../week5/schwartz.html">28. The Schwartzchild Equation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../week5/add_palette.html">29. Adding a palette to an axis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../solutions/assign2_solutionsC.html">30. Assignment 2: solutions part C</a></li>
<li class="toctree-l1"><a class="reference internal" href="../week5/hydrostat.html">31. Hydrostatic balance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../week5/cartopy_mapping_buenos_aires.html">32. Cartopy mapping Buenos Aires</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Week 6</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../solutions/assign3_solutions.html">33. Assignment 3: solutions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../week6/hydrostatic_balance.html">34. Scale heights for typical atmospheric soundings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../week6/weighting_functions.html">35. Weighting functions for temperature retrieval</a></li>
<li class="toctree-l1"><a class="reference internal" href="../week6/heating_rate.html">36. Finding the heating rate of the atmosphere</a></li>
<li class="toctree-l1"><a class="reference internal" href="../week6/assign4_two_layer_sol.html">37. Assignment 4 two layer solution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../solutions/assign4_solution.html">38. Assignment 4 solutions</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Week 7</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../week7/false_color.html">39. Making color composite (“false color”) images</a></li>
<li class="toctree-l1"><a class="reference internal" href="../week7/fmask.html">40. Using fmask to mask water pixels</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Week 8</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../week8/install_part1.html">41. Python packages Part 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../week8/goes_true_color.html">42. GOES-16: True Color Images from GOES ABI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../week8/goes_landsat.html">43. Combining goes and landsat data</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/notebooks/week4/clip_bands.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Clipping multiple bands– v0.2</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">22.1. Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#get-the-original-hls-tif-files-from-disk">22.2. Get the original hls tif files from disk</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#examine-the-geotif-metadata">22.3. Examine the geotif metadata</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#using-gdalinfo-from-the-terminal">22.3.1. Using gdalinfo from the terminal</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#using-the-python-gdal-api">22.3.2. Using the python gdal api</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dump-all-the-metadata">22.3.3. Dump all the metadata</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#read-the-bands-into-a-dictionary">22.4. Read the bands into a dictionary</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#check-the-dtype-of-the-data-and-missing-data">22.4.1. check the dtype of the data and missing data</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#read-the-clipped-week3-band-5-bounding-box">22.5. Read the clipped week3 band 5 bounding box</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#create-the-bounding-box-using-the-upper-left-and-lower-right-corners">22.5.1. Create the bounding box using the upper left and lower right corners</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#get-the-pyproj-crs-to-copy-to-output-tif">22.5.2. Get the pyproj crs to copy to output tif</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-new-clipped-arrays">22.6. Create new clipped arrays</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#check-the-brightness-temperature-in-band-11">22.7. Check the brightness temperature in band 11</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#write-the-clipped-geotiffs">22.8. Write the clipped geotiffs</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#change-some-attributes">22.8.1. change some attributes</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#check-the-attributes">22.8.1.1. check the attributes</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#write-out-the-new-geotiffs">22.8.2. Write out the new geotiffs</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#read-one-back-in-to-check">22.8.3. read one back in to check</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#note-that-we-now-have-the-correct-epsg-code">22.8.3.1. note that we now have the correct epsg code</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#check-the-metadata">22.8.3.2. Check the metadata</a></li>
</ul>
</li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="clipping-multiple-bands-v0-2">
<span id="week4-clip-bands"></span><h1><span class="section-number">22. </span>Clipping multiple bands– v0.2<a class="headerlink" href="#clipping-multiple-bands-v0-2" title="Link to this heading">#</a></h1>
<p>2025/Feb/27: Fixed a problem where the datatype of the clipped arrays was changed from float32 to int16 when creating geotiffs.  See <a class="reference internal" href="#clip-create-arrays"><span class="std std-ref">Create new clipped arrays</span></a> for the new code.</p>
<section id="introduction">
<h2><span class="section-number">22.1. </span>Introduction<a class="headerlink" href="#introduction" title="Link to this heading">#</a></h2>
<p>We are going to need to look at bands 2, 3, 4, 5, 9, 10 and 11.  This notebook uses the clipped band we wrote in
<a class="reference internal" href="../week3/zoom_landsat.html#week3-image-zoom"><span class="std std-ref">Zooming an image</span></a> to get the clipping box, then reads in each of these bands, clips to the same box
and writes them out to new smaller geotifs.</p>
<ul class="simple">
<li><p>Download clip_bands.ipynb from the <a class="reference external" href="https://drive.google.com/drive/folders/1-Ja2wVKVIjkZb7Gx_rfc14J_aBYiknuw?usp=sharing">week4 folder</a></p></li>
<li><p>You’ll also need to copy the 5 NASA hls tif files in the <a class="reference external" href="https://drive.google.com/drive/folders/1UwTc4MnneI2eZ6rHqKFzF4YdRRbQi4sS?usp=sharing">vancouver</a> folder into a new folder on your drive called <code class="docutils literal notranslate"><span class="pre">~/repos/a301/satdata/landsat/vancouver</span></code></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pprint</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">osgeo</span><span class="w"> </span><span class="kn">import</span> <span class="n">gdal</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">cartopy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy.random</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">rasterio</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">affine</span><span class="w"> </span><span class="kn">import</span> <span class="n">Affine</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.colors</span><span class="w"> </span><span class="kn">import</span> <span class="n">Normalize</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyproj</span><span class="w"> </span><span class="kn">import</span> <span class="n">CRS</span><span class="p">,</span> <span class="n">Transformer</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">rioxarray</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xr</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cartopy</span><span class="w"> </span><span class="kn">import</span> <span class="n">crs</span> <span class="k">as</span> <span class="n">ccrs</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">a301_lib</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_pal</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="get-the-original-hls-tif-files-from-disk">
<h2><span class="section-number">22.2. </span>Get the original hls tif files from disk<a class="headerlink" href="#get-the-original-hls-tif-files-from-disk" title="Link to this heading">#</a></h2>
<p>This cell finds all the 3660 x 3660 landsat tifs we downloaded in the satdata/landsat/vancouver folder.  We can use the <code class="docutils literal notranslate"><span class="pre">*</span></code> wildcard
so we don’t have to type in long filenames, and the <code class="docutils literal notranslate"><span class="pre">**</span></code> wildcard so we look in all subfolders.  If you’re interested  here’s
the <a class="reference external" href="https://en.wikipedia.org/wiki/Glob_(programming)#:~:text=6%20References-,Origin,command%3A%20%2Fetc%2Fglob.">wikipedia entry on globbing</a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">()</span><span class="o">.</span><span class="n">home</span><span class="p">()</span> <span class="o">/</span> <span class="s1">&#39;repos/a301/satdata/landsat&#39;</span>
<span class="n">the_tifs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;**/vancouver_2023/HLS.L30*tif&#39;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">the_tifs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[PosixPath(&#39;/Users/phil/repos/a301/satdata/landsat/vancouver_2023/HLS.L30.T10UDV.2023226T190707.v2.0.Fmask.tif&#39;), PosixPath(&#39;/Users/phil/repos/a301/satdata/landsat/vancouver_2023/HLS.L30.T10UDV.2023226T190707.v2.0.B05.tif&#39;)]
</pre></div>
</div>
</div>
</div>
</section>
<section id="examine-the-geotif-metadata">
<h2><span class="section-number">22.3. </span>Examine the geotif metadata<a class="headerlink" href="#examine-the-geotif-metadata" title="Link to this heading">#</a></h2>
<section id="using-gdalinfo-from-the-terminal">
<h3><span class="section-number">22.3.1. </span>Using gdalinfo from the terminal<a class="headerlink" href="#using-gdalinfo-from-the-terminal" title="Link to this heading">#</a></h3>
<p>It turns out that rioxarray only copies part of the metadata into the <code class="docutils literal notranslate"><span class="pre">DataArray</span></code>.  To get all the metadata, we can use the underlying <a class="reference external" href="https://gdal.org/en/stable/programs/gdalinfo.html">gdal module</a>. Do the following:</p>
<ul class="simple">
<li><p>open a terminal</p></li>
<li><p>cd to the folder holding the geotiff</p></li>
<li><p>type <code class="docutils literal notranslate"><span class="pre">gdalinfo</span> <span class="pre">your_tif_name_here.tif</span></code></p></li>
</ul>
<p>For a shorter summary, you can use the <code class="docutils literal notranslate"><span class="pre">rasterio</span></code> command line tool <code class="docutils literal notranslate"><span class="pre">rio</span></code>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">rio</span> <span class="pre">info</span> <span class="pre">you_tif_name_here.tif</span></code></p></li>
</ul>
</section>
<section id="using-the-python-gdal-api">
<h3><span class="section-number">22.3.2. </span>Using the python gdal api<a class="headerlink" href="#using-the-python-gdal-api" title="Link to this heading">#</a></h3>
<p>We can also do that from inside python.  To get all the information for the first tif, do:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">info</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Info</span><span class="p">(</span><span class="n">the_tifs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">)</span>
<span class="n">info</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/phil/mini310/envs/a301/lib/python3.13/site-packages/osgeo/gdal.py:311: FutureWarning: Neither gdal.UseExceptions() nor gdal.DontUseExceptions() has been explicitly called. In GDAL 4.0, exceptions will be enabled by default.
  warnings.warn(
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dict_keys([&#39;description&#39;, &#39;driverShortName&#39;, &#39;driverLongName&#39;, &#39;files&#39;, &#39;size&#39;, &#39;coordinateSystem&#39;, &#39;geoTransform&#39;, &#39;metadata&#39;, &#39;cornerCoordinates&#39;, &#39;wgs84Extent&#39;, &#39;bands&#39;, &#39;stac&#39;])
</pre></div>
</div>
</div>
</div>
</section>
<section id="dump-all-the-metadata">
<h3><span class="section-number">22.3.3. </span>Dump all the metadata<a class="headerlink" href="#dump-all-the-metadata" title="Link to this heading">#</a></h3>
<p>You can print the  <code class="docutils literal notranslate"><span class="pre">info</span></code> dictionary to see the full gdal metadata dictionary.
Scanning through it, will see that the <code class="docutils literal notranslate"><span class="pre">metadata</span></code> key has two sub-keys:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>info[&#39;metadata&#39;].keys()=dict_keys([&#39;&#39;, &#39;IMAGE_STRUCTURE&#39;])
</pre></div>
</div>
</div>
</div>
<p>And looking at the first key shows all of the metadata that rioxarray transfers to the DataArray attributes.  these are the entries that we’ll need to change for our clipped, scaled image.  We need to change <code class="docutils literal notranslate"><span class="pre">NCOLS,</span> <span class="pre">NROWS,</span> <span class="pre">ULX,</span> <span class="pre">ULY</span> <span class="pre">and</span> <span class="pre">scale_factor</span></code> when we write the clipped geotif.  Descriptions of each of the metadata items are in the <a class="reference external" href="https://lpdaac.usgs.gov/documents/1007/HLS_User_Guide_V15_provisional.pdf">hls user guide</a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">][</span><span class="s1">&#39;&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>info[&#39;metadata&#39;][&#39;&#39;].keys()=dict_keys([&#39;ACCODE&#39;, &#39;add_offset&#39;, &#39;arop_ave_xshift(meters)&#39;, &#39;arop_ave_yshift(meters)&#39;, &#39;arop_ncp&#39;, &#39;arop_rmse(meters)&#39;, &#39;arop_s2_refimg&#39;, &#39;cloud_coverage&#39;, &#39;HLS_PROCESSING_TIME&#39;, &#39;HORIZONTAL_CS_NAME&#39;, &#39;L1_PROCESSING_TIME&#39;, &#39;LANDSAT_PRODUCT_ID&#39;, &#39;LANDSAT_SCENE_ID&#39;, &#39;long_name&#39;, &#39;MEAN_SUN_AZIMUTH_ANGLE&#39;, &#39;MEAN_SUN_ZENITH_ANGLE&#39;, &#39;MEAN_VIEW_AZIMUTH_ANGLE&#39;, &#39;MEAN_VIEW_ZENITH_ANGLE&#39;, &#39;NBAR_SOLAR_ZENITH&#39;, &#39;NCOLS&#39;, &#39;NROWS&#39;, &#39;OVR_RESAMPLING_ALG&#39;, &#39;PROCESSING_LEVEL&#39;, &#39;scale_factor&#39;, &#39;SENSING_TIME&#39;, &#39;SENSOR&#39;, &#39;SENTINEL2_TILEID&#39;, &#39;spatial_coverage&#39;, &#39;SPATIAL_RESOLUTION&#39;, &#39;TIRS_SSM_MODEL&#39;, &#39;TIRS_SSM_POSITION_STATUS&#39;, &#39;ULX&#39;, &#39;ULY&#39;, &#39;USGS_SOFTWARE&#39;, &#39;_FillValue&#39;, &#39;AREA_OR_POINT&#39;])
</pre></div>
</div>
</div>
</div>
<p>We want to check the <code class="docutils literal notranslate"><span class="pre">long_name</span></code> key in particular, to make sure we are looking at the right wavelength:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">][</span><span class="s1">&#39;&#39;</span><span class="p">][</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>info[&#39;metadata&#39;][&#39;&#39;][&#39;long_name&#39;]=&#39;NIR&#39;
</pre></div>
</div>
</div>
</div>
<p>The exact wavelength range for each hls landsat band is given in the <a class="reference external" href="https://lpdaac.usgs.gov/data/get-started-data/collection-overview/missions/harmonized-landsat-sentinel-2-hls-overview/#hls-spectral-bands">spectral band table</a></p>
</section>
</section>
<section id="read-the-bands-into-a-dictionary">
<h2><span class="section-number">22.4. </span>Read the bands into a dictionary<a class="headerlink" href="#read-the-bands-into-a-dictionary" title="Link to this heading">#</a></h2>
<p>We’re ready to read all of the bands into a dictionary, keyed by the band <code class="docutils literal notranslate"><span class="pre">long_name</span></code>.  All the band names are listed in the
<a class="reference external" href="https://lpdaac.usgs.gov/data/get-started-data/collection-overview/missions/harmonized-landsat-sentinel-2-hls-overview/#hls-spectral-bands">spectral band table</a>. Note one complication – the <code class="docutils literal notranslate"><span class="pre">unit</span></code> attribute is only present for brightness temperatures, not reflectivities.</p>
<p>Note on the next cell:</p>
<ul class="simple">
<li><p>Because we set <code class="docutils literal notranslate"><span class="pre">masked_and_scale=True</span></code>, all <code class="docutils literal notranslate"><span class="pre">-9999</span></code> values are changed to <code class="docutils literal notranslate"><span class="pre">np.nan</span></code> and the data is multiplied by the scale factor and converted from <code class="docutils literal notranslate"><span class="pre">int16</span></code> to <code class="docutils literal notranslate"><span class="pre">float32</span></code></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">band_dict</span><span class="o">=</span><span class="p">{}</span>
<span class="k">for</span> <span class="n">tif_path</span> <span class="ow">in</span> <span class="n">the_tifs</span><span class="p">:</span>
    <span class="c1">#</span>
    <span class="c1"># skip fmask for now</span>
    <span class="c1">#</span>
    <span class="k">if</span> <span class="s1">&#39;Fmask&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">tif_path</span><span class="p">):</span>
        <span class="k">continue</span>
    <span class="n">hls_band</span> <span class="o">=</span> <span class="n">rioxarray</span><span class="o">.</span><span class="n">open_rasterio</span><span class="p">(</span><span class="n">tif_path</span><span class="p">,</span><span class="n">mask_and_scale</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">band_name</span> <span class="o">=</span> <span class="n">hls_band</span><span class="o">.</span><span class="n">long_name</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">band_name</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">band_dict</span><span class="p">[</span><span class="n">band_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">hls_band</span>
    <span class="k">if</span> <span class="s1">&#39;unit&#39;</span> <span class="ow">in</span> <span class="n">hls_band</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hls_band</span><span class="o">.</span><span class="n">unit</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>band_name=&#39;NIR&#39;
</pre></div>
</div>
</div>
</div>
<section id="check-the-dtype-of-the-data-and-missing-data">
<h3><span class="section-number">22.4.1. </span>check the dtype of the data and missing data<a class="headerlink" href="#check-the-dtype-of-the-data-and-missing-data" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">band_dict</span><span class="p">[</span><span class="s1">&#39;Green&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">band_dict</span><span class="p">[</span><span class="s1">&#39;Green&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">nodata</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">KeyError</span><span class="g g-Whitespace">                                  </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">band_dict</span><span class="p">[</span><span class="s1">&#39;Green&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">band_dict</span><span class="p">[</span><span class="s1">&#39;Green&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">nodata</span>

<span class="ne">KeyError</span>: &#39;Green&#39;
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="read-the-clipped-week3-band-5-bounding-box">
<h2><span class="section-number">22.5. </span>Read the clipped week3 band 5 bounding box<a class="headerlink" href="#read-the-clipped-week3-band-5-bounding-box" title="Link to this heading">#</a></h2>
<p>Next we want to get the affine transform from week 3 clipped band file, so we can set the same bounding box for all tifs</p>
<section id="create-the-bounding-box-using-the-upper-left-and-lower-right-corners">
<span id="bounding-box"></span><h3><span class="section-number">22.5.1. </span>Create the bounding box using the upper left and lower right corners<a class="headerlink" href="#create-the-bounding-box-using-the-upper-left-and-lower-right-corners" title="Link to this heading">#</a></h3>
<p>This should be identical to the bounding box we found in <a class="reference internal" href="../week3/zoom_landsat.html#zoom-landsat-array"><span class="std std-ref">Create the DataArray</span></a>, which was:</p>
<p><code class="docutils literal notranslate"><span class="pre">bounding_box=(476100.0,</span> <span class="pre">5447460.0,</span> <span class="pre">488100.0,</span> <span class="pre">5465460.0)</span></code></p>
<p>We can get them using the clipped affine transform.  Again, we search for the file using wild cards.  We just want
the first file we find, which means we need convert the python generator returned by glob into a list we can index.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">filename</span> <span class="o">=</span>  <span class="nb">list</span><span class="p">(</span><span class="n">data_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;**/band5_clipped*&#39;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
<span class="n">clipped_5</span> <span class="o">=</span> <span class="n">rioxarray</span><span class="o">.</span><span class="n">open_rasterio</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">masked</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">clipped_transform</span> <span class="o">=</span> <span class="n">clipped_5</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">transform</span><span class="p">()</span>
<span class="n">clipped_transform</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/phil/repos/a301/satdata/landsat/band5_clipped_rio.tif
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Affine(30.0, 0.0, 476100.0,
       0.0, -30.0, 5465460.0)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">band</span><span class="p">,</span> <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="n">clipped_5</span><span class="o">.</span><span class="n">shape</span>
<span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(600, 400)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ul_x</span><span class="p">,</span> <span class="n">ul_y</span> <span class="o">=</span> <span class="n">clipped_transform</span> <span class="o">*</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">lr_x</span><span class="p">,</span> <span class="n">lr_y</span> <span class="o">=</span> <span class="n">clipped_transform</span> <span class="o">*</span> <span class="p">(</span><span class="n">ncols</span><span class="p">,</span> <span class="n">nrows</span><span class="p">)</span>
<span class="n">bounding_box</span> <span class="o">=</span> <span class="p">(</span><span class="n">ul_x</span><span class="p">,</span> <span class="n">lr_y</span><span class="p">,</span> <span class="n">lr_x</span><span class="p">,</span> <span class="n">ul_y</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bounding_box</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>bounding_box=(476100.0, 5447460.0, 488100.0, 5465460.0)
</pre></div>
</div>
</div>
</div>
</section>
<section id="get-the-pyproj-crs-to-copy-to-output-tif">
<h3><span class="section-number">22.5.2. </span>Get the pyproj crs to copy to output tif<a class="headerlink" href="#get-the-pyproj-crs-to-copy-to-output-tif" title="Link to this heading">#</a></h3>
<p>We want the improved crs we wrote out in <a class="reference internal" href="../week3/zoom_landsat.html#week3-image-zoom"><span class="std std-ref">Zooming an image</span></a> for the band5 clipped tif, since  it includes the epsg code</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">good_crs</span> <span class="o">=</span> <span class="n">clipped_5</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">crs</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">good_crs</span><span class="o">.</span><span class="n">to_epsg</span><span class="p">()</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>good_crs.to_epsg()=32610
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="create-new-clipped-arrays">
<span id="clip-create-arrays"></span><h2><span class="section-number">22.6. </span>Create new clipped arrays<a class="headerlink" href="#create-new-clipped-arrays" title="Link to this heading">#</a></h2>
<p>Fixed in version 0.2:  Just copying all the metadata from the original NASA files led to issues with missing data values and the ouput datatype for the data. To fix this, create the rioxarray DataArrays from scratch with
only those attributes that are consistent with the new mask_and_scaled array.
We’ll add more attributes in <a class="reference internal" href="#change-attrs"><span class="std std-ref">change some attributes</span></a> below. In particular note
that ULX, ULY, NROWS and NCOLS have not been updated from the original full scene.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">make_new_array</span><span class="p">(</span><span class="n">rio_da</span><span class="p">,</span><span class="n">crs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    transfer data into from rio_da into a fresh DataArray, copying only the selected metadata</span>
<span class="sd">    from rio_da.  This avoids copying old metadata from the original hls tif file</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    rio_da: xarray DataArray</span>
<span class="sd">       a DataArray with rasterio metadata</span>
<span class="sd">    crs: optional pyproj crs</span>
<span class="sd">       a crs which is able to return its epsg code</span>
<span class="sd">       if it&#39;s missing, the crs from rio_da will be copied</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    clipped_da: xarray.DataArray</span>
<span class="sd">      a DataArray with metadata and data copied from rio_da</span>
<span class="sd">    </span>

<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#</span>
    <span class="c1"># NASA hls files have bad crs, so allow for an override parameter</span>
    <span class="c1">#</span>
    <span class="k">if</span> <span class="n">crs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">crs</span> <span class="o">=</span> <span class="n">rio_da</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">crs</span>
    <span class="n">clipped_da</span><span class="o">=</span><span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">rio_da</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">coords</span><span class="o">=</span><span class="n">rio_da</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span>
                            <span class="n">dims</span><span class="o">=</span><span class="n">rio_da</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
    <span class="n">clipped_da</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">write_crs</span><span class="p">(</span><span class="n">crs</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">clipped_da</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">write_transform</span><span class="p">(</span><span class="n">rio_da</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">transform</span><span class="p">(),</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">clipped_da</span><span class="o">=</span><span class="n">clipped_da</span><span class="o">.</span><span class="n">assign_attrs</span><span class="p">(</span><span class="n">rio_da</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>
    <span class="n">clipped_da</span> <span class="o">=</span> <span class="n">clipped_da</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">set_nodata</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">clipped_da</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">band_clipped</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">band_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">the_array</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">clip_box</span><span class="p">(</span><span class="o">*</span><span class="n">bounding_box</span><span class="p">)</span>
    <span class="n">new_clipped</span> <span class="o">=</span> <span class="n">make_new_array</span><span class="p">(</span><span class="n">the_array</span><span class="p">,</span><span class="n">crs</span> <span class="o">=</span> <span class="n">good_crs</span><span class="p">)</span>
    <span class="n">band_clipped</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">=</span><span class="n">new_clipped</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">var</span><span class="o">=</span><span class="s1">&#39;TIRS1&#39;</span>
<span class="n">band_clipped</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">nodata</span><span class="p">,</span> <span class="n">band_clipped</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">KeyError</span><span class="g g-Whitespace">                                  </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">15</span><span class="p">],</span> <span class="n">line</span> <span class="mi">2</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">var</span><span class="o">=</span><span class="s1">&#39;TIRS1&#39;</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="n">band_clipped</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">nodata</span><span class="p">,</span> <span class="n">band_clipped</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span>

<span class="ne">KeyError</span>: &#39;TIRS1&#39;
</pre></div>
</div>
</div>
</div>
</section>
<section id="check-the-brightness-temperature-in-band-11">
<h2><span class="section-number">22.7. </span>Check the brightness temperature in band 11<a class="headerlink" href="#check-the-brightness-temperature-in-band-11" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">band_clipped</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">nodata</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>nan
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;TIRS2&#39;</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">band_clipped</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;band </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">band_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">KeyError</span><span class="g g-Whitespace">                                  </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">17</span><span class="p">],</span> <span class="n">line</span> <span class="mi">3</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;TIRS2&#39;</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="ne">----&gt; </span><span class="mi">3</span> <span class="n">band_clipped</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;band </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">band_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

<span class="ne">KeyError</span>: &#39;TIRS2&#39;
</pre></div>
</div>
<img alt="../../_images/8852035462ddaea257dd94f8f88f277b0993cb5e85d77d5a256d5d65b3ca98dc.png" src="../../_images/8852035462ddaea257dd94f8f88f277b0993cb5e85d77d5a256d5d65b3ca98dc.png" />
</div>
</div>
</section>
<section id="write-the-clipped-geotiffs">
<h2><span class="section-number">22.8. </span>Write the clipped geotiffs<a class="headerlink" href="#write-the-clipped-geotiffs" title="Link to this heading">#</a></h2>
<p>Put these into the vancouver folder.  We can copy code from <a class="reference internal" href="../week3/zoom_landsat.html#week3-write-clipped"><span class="std std-ref">add the transform and the crs</span></a></p>
<section id="change-some-attributes">
<span id="change-attrs"></span><h3><span class="section-number">22.8.1. </span>change some attributes<a class="headerlink" href="#change-some-attributes" title="Link to this heading">#</a></h3>
<p>We need to adjust some of the attributions for the new subscene.  To do this, copy the exiting attributes into
a dictionary and rewrite the parts you want to change, adding any extras.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">band_clipped</span><span class="p">[</span><span class="s1">&#39;Red&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span><span class="n">band_clipped</span><span class="p">[</span><span class="s1">&#39;Red&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">nodata</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">KeyError</span><span class="g g-Whitespace">                                  </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">18</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">band_clipped</span><span class="p">[</span><span class="s1">&#39;Red&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span><span class="n">band_clipped</span><span class="p">[</span><span class="s1">&#39;Red&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">nodata</span>

<span class="ne">KeyError</span>: &#39;Red&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">value</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">set_nodata</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">_nodata</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>numpy.float32
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">band_clipped</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">new_attrs</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>
    <span class="n">new_attrs</span><span class="p">[</span><span class="s1">&#39;ULX&#39;</span><span class="p">]</span><span class="o">=</span> <span class="n">ul_x</span>
    <span class="n">new_attrs</span><span class="p">[</span><span class="s1">&#39;ULY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ul_y</span>
    <span class="n">band</span><span class="p">,</span> <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">new_attrs</span><span class="p">[</span><span class="s1">&#39;NROWS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nrows</span>
    <span class="n">new_attrs</span><span class="p">[</span><span class="s1">&#39;NCOLS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ncols</span>
    <span class="n">new_attrs</span><span class="p">[</span><span class="s1">&#39;FillValue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">new_attrs</span><span class="p">[</span><span class="s1">&#39;history&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;v0.2 -- written by the week4 clip_bands notebook&quot;</span>
    <span class="n">value</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">update_attrs</span><span class="p">(</span><span class="n">new_attrs</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="c1"># update_attrs seems to destroy the rio.nodata attribute</span>
    <span class="c1">#</span>
    <span class="n">value</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">set_nodata</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<section id="check-the-attributes">
<h4><span class="section-number">22.8.1.1. </span>check the attributes<a class="headerlink" href="#check-the-attributes" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">value</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;history&#39;</span><span class="p">],</span><span class="n">value</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span><span class="n">value</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">nodata</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;v0.2 -- written by the week4 clip_bands notebook&#39;,
 dtype(&#39;float32&#39;),
 np.float32(nan))
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="write-out-the-new-geotiffs">
<h3><span class="section-number">22.8.2. </span>Write out the new geotiffs<a class="headerlink" href="#write-out-the-new-geotiffs" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">band_clipped</span><span class="p">[</span><span class="s1">&#39;Blue&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">10</span><span class="p">:]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">KeyError</span><span class="g g-Whitespace">                                  </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">22</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">band_clipped</span><span class="p">[</span><span class="s1">&#39;Blue&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">10</span><span class="p">:]</span>

<span class="ne">KeyError</span>: &#39;Blue&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">band_clipped</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">band_name</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">long_name</span>
    <span class="n">tif_filename</span> <span class="o">=</span> <span class="n">data_dir</span> <span class="o">/</span> <span class="s1">&#39;vancouver&#39;</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;week4_clipped_</span><span class="si">{</span><span class="n">band_name</span><span class="si">}</span><span class="s2">.tif&quot;</span>
    <span class="c1">#</span>
    <span class="c1"># remove the file if it already exists</span>
    <span class="c1">#</span>
    <span class="k">if</span> <span class="n">tif_filename</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">tif_filename</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
    <span class="n">value</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">to_raster</span><span class="p">(</span><span class="n">tif_filename</span><span class="p">)</span>
<span class="n">value</span> <span class="o">=</span> <span class="n">band_clipped</span><span class="p">[</span><span class="s1">&#39;Blue&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">10</span><span class="p">:])</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">nodata</span><span class="p">,</span><span class="n">value</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">to_epsg</span><span class="p">())</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">KeyError</span><span class="g g-Whitespace">                                  </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">23</span><span class="p">],</span> <span class="n">line</span> <span class="mi">10</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span>         <span class="n">tif_filename</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
<span class="g g-Whitespace">      </span><span class="mi">9</span>     <span class="n">value</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">to_raster</span><span class="p">(</span><span class="n">tif_filename</span><span class="p">)</span>
<span class="ne">---&gt; </span><span class="mi">10</span> <span class="n">value</span> <span class="o">=</span> <span class="n">band_clipped</span><span class="p">[</span><span class="s1">&#39;Blue&#39;</span><span class="p">]</span>
<span class="g g-Whitespace">     </span><span class="mi">11</span> <span class="nb">print</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">10</span><span class="p">:])</span>
<span class="g g-Whitespace">     </span><span class="mi">12</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">nodata</span><span class="p">,</span><span class="n">value</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">to_epsg</span><span class="p">())</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="ne">KeyError</span>: &#39;Blue&#39;
</pre></div>
</div>
</div>
</div>
</section>
<section id="read-one-back-in-to-check">
<h3><span class="section-number">22.8.3. </span>read one back in to check<a class="headerlink" href="#read-one-back-in-to-check" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tif_filename</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;**/*week4*NIR.tif&quot;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tif_filename</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">has_file</span> <span class="o">=</span> <span class="n">tif_filename</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">has_file</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;can&#39;t find </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">, something went wrong above&quot;</span><span class="p">)</span> 
<span class="n">small_band</span> <span class="o">=</span> <span class="n">rioxarray</span><span class="o">.</span><span class="n">open_rasterio</span><span class="p">(</span><span class="n">tif_filename</span><span class="p">,</span><span class="n">mask_and_scale</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">small_band</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">10</span><span class="p">:]</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">small_band</span> <span class="o">=</span> <span class="n">small_band</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
<span class="n">band_name</span> <span class="o">=</span> <span class="n">small_band</span><span class="o">.</span><span class="n">long_name</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="p">(</span><span class="n">band_name</span><span class="p">,</span><span class="w"> </span><span class="n">small_band</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span><span class="mf">0.5</span>
<span class="n">pal_dict</span> <span class="o">=</span> <span class="n">make_pal</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
<span class="n">small_band</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                    <span class="n">norm</span> <span class="o">=</span> <span class="n">pal_dict</span><span class="p">[</span><span class="s1">&#39;norm&#39;</span><span class="p">],</span>
                    <span class="n">cmap</span> <span class="o">=</span> <span class="n">pal_dict</span><span class="p">[</span><span class="s1">&#39;cmap&#39;</span><span class="p">],</span>
                    <span class="n">extend</span> <span class="o">=</span> <span class="s2">&quot;both&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Landsat band </span><span class="si">{</span><span class="n">band_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>tif_filename=PosixPath(&#39;/Users/phil/repos/a301/satdata/landsat/vancouver/week4_clipped_NIR.tif&#39;)
small_band.data[0,-1,-10:]=array([0.227     , 0.2357    , 0.19999999, 0.2024    , 0.213     ,
       0.1812    , 0.2015    , 0.2394    , 0.23099999, 0.2409    ],
      dtype=float32)
(band_name, small_band.dtype)=(&#39;NIR&#39;, dtype(&#39;float32&#39;))
</pre></div>
</div>
<img alt="../../_images/64cfebe30e5052fa1dd3fd2b8bba7895ec22c916809673301c79563f3e8bffac.png" src="../../_images/64cfebe30e5052fa1dd3fd2b8bba7895ec22c916809673301c79563f3e8bffac.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">small_band</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;history&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;v0.2 -- written by the week4 clip_bands notebook&#39;
</pre></div>
</div>
</div>
</div>
<section id="note-that-we-now-have-the-correct-epsg-code">
<h4><span class="section-number">22.8.3.1. </span>note that we now have the correct epsg code<a class="headerlink" href="#note-that-we-now-have-the-correct-epsg-code" title="Link to this heading">#</a></h4>
<p>Because we used the pyproj <code class="docutils literal notranslate"><span class="pre">good_crs</span></code> in our raster write we’ve fixed the missing epsg code problem.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">small_band</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">to_epsg</span><span class="p">(),</span> <span class="n">small_band</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">nodata</span><span class="p">,</span><span class="n">small_band</span><span class="o">.</span><span class="n">dtype</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(32610, np.float32(nan), dtype(&#39;float32&#39;))
</pre></div>
</div>
</div>
</div>
</section>
<section id="check-the-metadata">
<h4><span class="section-number">22.8.3.2. </span>Check the metadata<a class="headerlink" href="#check-the-metadata" title="Link to this heading">#</a></h4>
<p>Write all the metadata out to a file for a detailed check</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">info</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Info</span><span class="p">(</span><span class="n">tif_filename</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tif_filename</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;dump.json&#39;</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
    <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">info</span><span class="p">,</span><span class="n">fp</span><span class="p">,</span><span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>tif_filename=PosixPath(&#39;/Users/phil/repos/a301/satdata/landsat/vancouver/week4_clipped_NIR.tif&#39;)
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/week4"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../week3/optical_depth.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title"><span class="section-number">21. </span>Optical depth and partial transmission</p>
      </div>
    </a>
    <a class="right-next"
       href="optical_depth2.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">23. </span>Optical depth II: mean free path</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">22.1. Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#get-the-original-hls-tif-files-from-disk">22.2. Get the original hls tif files from disk</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#examine-the-geotif-metadata">22.3. Examine the geotif metadata</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#using-gdalinfo-from-the-terminal">22.3.1. Using gdalinfo from the terminal</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#using-the-python-gdal-api">22.3.2. Using the python gdal api</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dump-all-the-metadata">22.3.3. Dump all the metadata</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#read-the-bands-into-a-dictionary">22.4. Read the bands into a dictionary</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#check-the-dtype-of-the-data-and-missing-data">22.4.1. check the dtype of the data and missing data</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#read-the-clipped-week3-band-5-bounding-box">22.5. Read the clipped week3 band 5 bounding box</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#create-the-bounding-box-using-the-upper-left-and-lower-right-corners">22.5.1. Create the bounding box using the upper left and lower right corners</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#get-the-pyproj-crs-to-copy-to-output-tif">22.5.2. Get the pyproj crs to copy to output tif</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-new-clipped-arrays">22.6. Create new clipped arrays</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#check-the-brightness-temperature-in-band-11">22.7. Check the brightness temperature in band 11</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#write-the-clipped-geotiffs">22.8. Write the clipped geotiffs</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#change-some-attributes">22.8.1. change some attributes</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#check-the-attributes">22.8.1.1. check the attributes</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#write-out-the-new-geotiffs">22.8.2. Write out the new geotiffs</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#read-one-back-in-to-check">22.8.3. read one back in to check</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#note-that-we-now-have-the-correct-epsg-code">22.8.3.1. note that we now have the correct epsg code</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#check-the-metadata">22.8.3.2. Check the metadata</a></li>
</ul>
</li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Philip Austin
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>